\begin{tikzpicture}
    % defining constants
    \def\stepSize{0.25}
    \def\Nnum{9}
    \def\fnum{8}
    \def\pnum{4}
    
    % Defining lengths
    % \newlength{\onelen}
    \setlength{\onelen}{\stepSize cm}
    % \newlength{\BrCl}
    \setlength{\BrCl}{0.075cm}
    % \newlength{\BrIn}
    \setlength{\BrIn}{0.15cm}
    % \newlength{\plen}
    \setlength{\plen}{1cm}%{\pnum\stepSize cm}
    % \newlength{\flen}
    \setlength{\flen}{2cm}%{\fnum*\stepSize cm}
    % \newlength{\Nlen}
    \setlength{\Nlen}{2.25cm}%{\Nnum\stepSize cm}%should be 2*p+one
    % \newlength{\MatClearance}
    \setlength{\MatClearance}{0.3cm}
    
    % grid lines for guidance
    % \draw[gray,step=0.5] (-0,-7) grid (8,3);

    % ======================= drawing data matrix =======================
    \path (0,2\plen+\onelen) coordinate (M1D);
    \path ([yshift=-2\plen-2\flen]M1D) coordinate (M1A);
    \path ([xshift=\Nlen]M1A) coordinate (M1B);
    \path ([yshift=2*\plen+2*\flen]M1B) coordinate (M1C);
    \draw[line width=1.5pt] ([xshift=\BrIn,yshift=-\BrCl]M1A) -- ([xshift=-\BrCl,yshift=-\BrCl]M1A) -- ([xshift=-\BrCl,yshift=\BrCl]M1D) -- ([xshift=\BrIn,yshift=\BrCl]M1D); %left bracket
    \draw[line width=1.5pt] ([xshift=-\BrIn,yshift=-\BrCl]M1B) -- ([xshift=\BrCl,yshift=-\BrCl]M1B) -- ([xshift=\BrCl,yshift=\BrCl]M1C) -- ([xshift=-\BrIn,yshift=\BrCl]M1C); %right bracket
    \draw[line width=1pt] ([yshift=\flen]M1A) -- ([yshift=\flen]M1B); % dividing matrix into blocks
    \fill[black, opacity=0.5] (M1A) rectangle (M1C);
    \foreach \x in {0,...,8} { % drawing black dots
    \foreach \y in {-15,...,8} {
      \fill ( {(\x+0.5)*\onelen}, {(\y+0.5)*\onelen} ) circle (1pt);
    }}
    \draw[line width=0.1pt] ([yshift=-\plen-\flen]M1D) -- ([yshift=-\plen-\flen]M1C);
    \draw[line width=0.1pt] ([yshift=-\plen]M1D) -- ([yshift=-\plen]M1C);

    % coordinates for diagonals
    \path ([yshift=-\plen]M1D) coordinate (M1stair1A);
    \path ([xshift=\Nlen]M1D) coordinate (M1stair1I);
    % black diagonals
    % \foreach \i in {0,-1}{
    % \foreach \dy in {1,...,18}{
    % \ifthenelse{\dy<9.5}{
    % % This code will be executed if \dy<9.5
    %     \draw[dash pattern=on 1pt off 2pt, line width=0.1pt] ([xshift= 0.5*\onelen,yshift=\i*(\plen+\flen)-(\dy+0.5)*\onelen]M1D) -- ([xshift= (\dy+0.5)*\onelen,yshift=\i*(\plen+\flen)-0.5*\onelen]M1D);
    % }{
    % % This code will be executed if \dy>=10
    %     \ifthenelse{\dy<12.5}{
    %         % This code will be executed if \dy<=12
    %         \draw[dash pattern=on 1pt off 2pt, line width=0.1pt] ([xshift= 0.5*\onelen,yshift=\i*(\plen+\flen)-(\dy+0.5)*\onelen]M1D) -- ([xshift= -0.5*\onelen,yshift=\i*(\plen+\flen)-(\dy-7.5)*\onelen]M1C);
    %         }{
    %         % This code will be executed if \dy>=13
    %         \draw[dash pattern=on 1pt off 2pt, line width=0.1pt] ([xshift= (\dy-10.5)*\onelen,yshift=\i*(\plen+\flen)-\plen-\flen+0.5*\onelen]M1D) -- ([xshift= -0.5*\onelen,yshift=\i*(\plen+\flen)-(\dy-7.5)*\onelen]M1C);
    %     }
    % }
    % }}
    
    % ---------------- drawing left brace and matrix ----------------
    \path ([xshift=-0.5\BrIn,yshift=-2\BrCl]M1A) coordinate (Brace1L);
    \path ([xshift=0.5\BrIn,yshift=-2\BrCl]M1B) coordinate (Brace1R);
    \draw[decorate, decoration={calligraphic brace, amplitude=3pt, mirror, aspect=0.75},line width=1pt] (Brace1L) -- (Brace1R);
    \node (mat1) at ($(Brace1L)!0.75!(Brace1R) + (0,-3pt)$) {};
    \node[below] at (mat1.center) {$\begin{bmatrix}
        U_{i,p,N}\\U_{i_p,f,N}\\Y_{i,p,N}\\ \hline Y_{i_p,f,N}
    \end{bmatrix}$};
    % brace to the left
    \path ([xshift=-0.75cm-0.05cm,yshift=-4pt]mat1.center) coordinate (Brace1T);
    \path ([yshift=-1.73cm]Brace1T) coordinate (Brace1B);
    \draw[pen colour=gray!60,decorate, decoration={calligraphic brace, amplitude=3pt, mirror, aspect=0.2},line width=0.75pt] (Brace1T) -- (Brace1B);
    % Zp
    \node (Zp) at ($(Brace1T)!0.2!(Brace1B) + (-3pt,-0.8pt)$) {};
    \node[left,text=gray!100,align=center] at ([xshift=0.5mm,yshift=-0.18cm]Zp.center) {\scriptsize{\shortstack{$=$\\$\Phi_{i,f,N}$}}};
  
    % ======================= drawing G =======================
    % useful coordinates
    \path ([xshift=\MatClearance,yshift=-0.5\Nlen-\plen-\flen]M1C) coordinate (M2A);
    \path ([xshift=\onelen]M2A) coordinate (M2B);
    \path ([yshift=\Nlen]M2B) coordinate (M2C);
    \path ([xshift=-\onelen]M2C) coordinate (M2D);

    % brackets
    \draw[line width=1.5pt] ([xshift=0.5\BrIn,yshift=-\BrCl]M2A) -- ([xshift=-\BrCl,yshift=-\BrCl]M2A) -- ([xshift=-\BrCl,yshift=\BrCl]M2D) -- ([xshift=0.5\BrIn,yshift=\BrCl]M2D); %left bracket
    \draw[line width=1.5pt] ([xshift=-0.5\BrIn,yshift=-\BrCl]M2B) -- ([xshift=\BrCl,yshift=-\BrCl]M2B) -- ([xshift=\BrCl,yshift=\BrCl]M2C) -- ([xshift=-0.5\BrIn,yshift=\BrCl]M2C); %right bracket
    
    % red fill
    \fill[red!50,opacity=0.5] (M2A) rectangle (M2C);

    % drawing red dots
    \foreach \x in {0} {
    \foreach \y in {0,...,8} {
      \fill[red] ([xshift=(\x+0.5)*\onelen,yshift=(\y+0.5)*\onelen]M2A) circle (1pt);
    }}

    % drawing middle brace and matrix
    \coordinate (Brace2L) at ([xshift=-0.5\BrIn]M2A |- Brace1L);
    \coordinate (Brace2R) at ([xshift=0.5\BrIn]M2B |- Brace1L);
    \draw[decorate, decoration={calligraphic brace, amplitude=3pt, mirror, aspect=0.5},line width=1pt] (Brace2L) -- (Brace2R);
    \node (mat1) at ($(Brace2L)!0.5!(Brace2R) + (0,-3pt)$) {};
    \node[below] at ([yshift=-1.05cm]mat1.center) {$g$};
    
    % ======================= drawing equal sign ======================= 
    \path ([xshift=\MatClearance*3/4,yshift=\Nlen/2-0.1cm]M2B) coordinate (EqA);
    \path ([xshift=0.4cm]EqA) coordinate (EqB);
    \path ([yshift=0.2cm]EqB) coordinate (EqC);
    \path ([xshift=-0.4cm]EqC) coordinate (EqD);
    \draw[line width = 1.5 pt] (EqA) -- (EqB);
    \draw[line width = 1.5 pt] (EqD) -- (EqC);

    % ---------------- equation sign below ----------------
    \node[below] at ([xshift=2\onelen,yshift=-1.05cm]mat1.center) {$=$};

    % ======================= drawing RHS =======================
    % inside of matrix
    \path ([xshift=0.75\MatClearance]EqB |- M1A) coordinate (M3A);
    \path ([xshift=\onelen]M3A) coordinate (M3B);
    \path ([yshift=2\plen+2\flen]M3B) coordinate (M3C);
    \path ([xshift=-\onelen]M3C) coordinate (M3D);
    
    % fill figures
    \fill[black,opacity=0.5]  (M3D) -- ([yshift=-\plen]M3D) -- ([yshift=-\plen]M3C) -- (M3C) -- cycle;
    \fill[red!50,opacity=0.5] ([yshift=-\plen]M3D) -- ([yshift=-\plen-\flen]M3D) -- ([yshift=-\plen-\flen]M3C) -- ([yshift=-\plen]M3C) -- cycle;
    \fill[black,opacity=0.5] ([yshift=\flen]M3A) -- ([yshift=\flen]M3B) -- ([yshift=\flen+\plen]M3B) -- ([yshift=\flen+\plen]M3A) -- cycle;
    \fill[red!50,opacity=0.5]  (M3A) -- (M3B) -- ([yshift=\flen]M3B) -- ([yshift=\flen]M3A) -- cycle;
    
    % draw brackets
    \draw[line width=1.5pt] ([xshift=0.5\BrIn,yshift=-\BrCl]M3A) -- ([xshift=-\BrCl,yshift=-\BrCl]M3A) -- ([xshift=-\BrCl,yshift=\BrCl]M3D) -- ([xshift=0.5\BrIn,yshift=\BrCl]M3D); %left bracket
    \draw[line width=1.5pt] ([xshift=-0.5\BrIn,yshift=-\BrCl]M3B) -- ([xshift=\BrCl,yshift=-\BrCl]M3B) -- ([xshift=\BrCl,yshift=\BrCl]M3C) -- ([xshift=-0.5\BrIn,yshift=\BrCl]M3C); %right bracket
    
    % U_{i,p,1}
    \foreach \dy in {0,...,-3}{
        \fill[black] ([xshift=0.5\onelen,yshift=(\dy-0.5)*\onelen]M3D) circle (1pt);
    }

    % U_{i_p,f,1}
    \foreach \dy in {-4,...,-11}{
        \fill[red] ([xshift=0.5\onelen,yshift=(\dy-0.5)*\onelen]M3D) circle (1pt);
    }
    
    % Y_{i,p,1}
    \foreach \dy in {0,...,-3}{
        \fill[black] ([xshift=0.5\onelen,yshift=(\dy-0.5)*\onelen-\plen-\flen]M3D) circle (1pt);
    }

    % Y_{i_p,f,1}
    \foreach \dy in {-4,...,-11}{
        \fill[red] ([xshift=0.5\onelen,yshift=(\dy-0.5)*\onelen-\plen-\flen]M3D) circle (1pt);
    }

    % draw dividers
    \draw[line width=0.1pt] ([yshift=-\plen]M3D) -- ([yshift=-\plen]M3C);
    \draw[line width=0.1pt] ([yshift=-\plen-\flen]M3D) -- ([yshift=-\plen-\flen]M3C);
    \draw[line width=1pt] ([yshift=\flen]M3A) -- ([yshift=\flen]M3B);

    % ---------------- drawing right brace and matrix ----------------
    % brace below matrix
    \path ([xshift=-0.5\BrIn,yshift=-2\BrCl]M3A) coordinate (Brace3L);
    \path ([xshift=0.5\BrIn,yshift=-2\BrCl]M3B) coordinate (Brace3R);
    \draw[decorate, decoration={calligraphic brace, amplitude=3pt, mirror, aspect=0.5},line width=1pt] (Brace3L) -- (Brace3R);
    % matrix below brace
    \node (mat3) at ($(Brace3L)!0.5!(Brace3R) + (0,-3pt)$) {};
    \node[below] at ([xshift=0.35cm]mat3.center) {$\begin{bmatrix}
        U_{\hat{i},p,1}\\U_{\hat{i}_p,f,1}\\Y_{\hat{i},p,1}\\ \hline Y_{\hat{i}_p,f,1}
    \end{bmatrix}$};
    % tag & label (on RHS of column)
    \node[below left] at (8.35cm,-5cm) {$\refstepcounter{equation}(\theequation)\label{eq:regular_DeePC_no_IVs}$};
    % brace to the right
    \path ([xshift=1.1cm]mat3.center |- Brace1T) coordinate (Brace3T);%([xshift=0.7cm,yshift=-4pt]mat3.center) coordinate (Brace3T);
    \path (Brace3T |- Brace1B) coordinate (Brace3B);
    \draw[pen colour=gray!60,decorate, decoration={calligraphic brace, amplitude=3pt, aspect=0.2},line width=0.75pt] (Brace3T) -- (Brace3B);
    % Zf
    \node (Zf) at ($(Brace3T)!0.2!(Brace3B) + (3pt,-1.5pt)$) {};
    \node[right,text=gray!100] at ([yshift=-0.18cm]Zf.center) {\scriptsize{\shortstack{$=$\\$\Phi_{\hat{i},f,1}$}}};
    
    % ======================= length indicators ======================= 
    \draw[|-|] ([yshift=\onelen]M1D) -- node[above] {\scriptsize$N$} ([yshift=\onelen]M1C);
    \draw[|-|] ([xshift=\onelen]M3C) -- node[right] {\scriptsize$pr$} ([xshift=\onelen,yshift=-\plen]M3C);
    \draw[|-|] ([xshift=\onelen,yshift=-\plen]M3C) -- node[right] {\scriptsize$fr$} ([xshift=\onelen,yshift=-\plen-\flen]M3C);
    \draw[|-|] ([xshift=\onelen,yshift=-\plen-\flen]M3C) -- node[right] {\scriptsize$pl$} ([xshift=\onelen,yshift=\flen]M3B);
    \draw[|-|] ([xshift=\onelen,yshift=\flen]M3B) -- node[right] {\scriptsize$fl$} ([xshift=\onelen]M3B);
\end{tikzpicture}